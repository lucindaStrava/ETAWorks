{"paragraphs":[{"text":"import spark.implicits._\nimport org.apache.spark.sql.{DataFrame, SaveMode}\nimport org.apache.spark.sql.functions.{broadcast, col, sum}","user":"anonymous","dateUpdated":"2020-01-08T23:25:36+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import spark.implicits._\nimport org.apache.spark.sql.{DataFrame, SaveMode}\nimport org.apache.spark.sql.functions.{broadcast, col, sum}\n"}]},"apps":[],"jobName":"paragraph_1575317641946_-589961961","id":"20191125-201541_1488915145","dateCreated":"2019-12-02T20:14:01+0000","dateStarted":"2020-01-08T23:25:36+0000","dateFinished":"2020-01-08T23:25:51+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:136117"},{"text":"\n  case class EdgeStat(\n                       activityId: Long,\n                       athleteId: Long,\n                       edgeUID: Long,\n                       activityType: Int,\n                       meanDistance: Double,\n                       elapsedTime: Double,\n                       meanSpeed: Double,\n                       speedFeatures: Option[Array[Double]],\n                       elevationFeatures: Option[Array[Double]],\n                       cadenceFeatures: Option[Array[Double]],\n                       heartrateFeatures: Option[Array[Double]],\n                       powerFeatures: Option[Array[Double]]\n                     )\n\n  ","user":"anonymous","dateUpdated":"2020-01-08T23:25:42+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"defined class EdgeStat\n"}]},"apps":[],"jobName":"paragraph_1575317641956_2140826374","id":"20191120-191348_1752848390","dateCreated":"2019-12-02T20:14:01+0000","dateStarted":"2020-01-08T23:25:42+0000","dateFinished":"2020-01-08T23:25:51+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136118"},{"text":"spark.read.load(s\"s3a://strava.scratch/gbm/bay-area/edgeStat_byEdgeUID\").createOrReplaceTempView(\"edges\")","user":"anonymous","dateUpdated":"2020-01-08T23:28:24+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1578525997768_-454341785","id":"20200108-232637_299322207","dateCreated":"2020-01-08T23:26:37+0000","dateStarted":"2020-01-08T23:28:24+0000","dateFinished":"2020-01-08T23:28:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136119"},{"text":"val mySql = \"\"\"\nselect\nedgeUID, athleteId, min(elapsedTime) as minTime, avg(elapsedTime) as avgTime,\ncount(1) as numTraversal\n\nfrom edges\ngroup by edgeUID, athleteId\n\"\"\"","user":"anonymous","dateUpdated":"2020-01-08T23:28:39+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"mySql: String =\n\"\nselect\nedgeUID, athleteId, min(elapsedTime) as minTime, avg(elapsedTime) as avgTime,\ncount(1) as numTraversal\n\nfrom edges\ngroup by edgeUID, athleteId\n\"\n"}]},"apps":[],"jobName":"paragraph_1575327120425_999018104","id":"20191202-225200_1458563999","dateCreated":"2019-12-02T22:52:00+0000","dateStarted":"2020-01-08T23:28:39+0000","dateFinished":"2020-01-08T23:28:39+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136120"},{"text":"// this is the super set ground truth\nRange(0, 20).foreach{ key =>\n    print(s\"Process key = $key\")\n    val edgeDF = spark.read.load(s\"s3a://strava.scratch/gbm/bay-area/edgeStat_byEdgeUID/key=$key\").filter(col(\"activityType\").equalTo(0))\n    edgeDF.createOrReplaceTempView(\"edges\")\n    spark.sql(mySql).repartition(1).write.mode(SaveMode.Overwrite).option(\"compression\", \"gzip\").parquet(s\"s3a://strava.scratch/gbm/bay-area/etaGroundTruth/key=$key\")\n}","user":"anonymous","dateUpdated":"2020-01-08T23:32:19+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Process key = 0Process key = 1Process key = 2Process key = 3Process key = 4Process key = 5Process key = 6Process key = 7Process key = 8Process key = 9Process key = 10Process key = 11Process key = 12Process key = 13Process key = 14Process key = 15Process key = 16Process key = 17Process key = 18Process key = 19"}]},"apps":[],"jobName":"paragraph_1575326852966_426870422","id":"20191202-224732_2110544906","dateCreated":"2019-12-02T22:47:32+0000","dateStarted":"2020-01-08T23:32:19+0000","dateFinished":"2020-01-08T23:36:46+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136121"},{"text":"val df = spark.read.load(s\"s3a://strava.scratch/gbm/bay-area/etaGroundTruth\")\ndf.createOrReplaceTempView(\"truth\")\ndf.printSchema","user":"anonymous","dateUpdated":"2020-01-08T23:37:19+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df: org.apache.spark.sql.DataFrame = [edgeUID: bigint, athleteId: bigint ... 4 more fields]\nroot\n |-- edgeUID: long (nullable = true)\n |-- athleteId: long (nullable = true)\n |-- minTime: double (nullable = true)\n |-- avgTime: double (nullable = true)\n |-- numTraversal: long (nullable = true)\n |-- key: integer (nullable = true)\n\n"}]},"apps":[],"jobName":"paragraph_1575323168833_2024142205","id":"20191202-214608_1212262592","dateCreated":"2019-12-02T21:46:08+0000","dateStarted":"2020-01-08T23:37:19+0000","dateFinished":"2020-01-08T23:37:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136122"},{"text":"\nval mySql = \"\"\"\n\nselect edgeUID, athleteId, minTime as label, double(1.0) as is_best_effort\nfrom truth\nwhere numTraversal > 5\nunion\nselect edgeUID, athleteId, avgTime as label, double(0.0) as is_best_effort\nfrom truth\nwhere numTraversal > 5\n\"\"\"\n\nval result = spark.sql(mySql)\nresult.printSchema\n\n","user":"anonymous","dateUpdated":"2020-01-08T23:38:04+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"mySql: String =\n\"\n\nselect edgeUID, athleteId, minTime as label, double(1.0) as is_best_effort\nfrom truth\nwhere numTraversal > 5\nunion\nselect edgeUID, athleteId, avgTime as label, double(0.0) as is_best_effort\nfrom truth\nwhere numTraversal > 5\n\"\nresult: org.apache.spark.sql.DataFrame = [edgeUID: bigint, athleteId: bigint ... 2 more fields]\nroot\n |-- edgeUID: long (nullable = true)\n |-- athleteId: long (nullable = true)\n |-- label: double (nullable = true)\n |-- is_best_effort: double (nullable = false)\n\ntraining: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [edgeUID: bigint, athleteId: bigint ... 2 more fields]\nvalidation: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [edgeUID: bigint, athleteId: bigint ... 2 more fields]\n"}]},"apps":[],"jobName":"paragraph_1575579339335_-799324122","id":"20191205-205539_594798106","dateCreated":"2019-12-05T20:55:39+0000","dateStarted":"2020-01-08T23:37:37+0000","dateFinished":"2020-01-08T23:37:38+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136123"},{"text":"// this set already filters down to traversal > 5 and partitioned to training and validation such that we can make sure training/validation split is exactly the same moving forward for model iteration\nval Array(trainingTruth, validationTruth) = result.randomSplit(Array(0.9, 0.1), seed = 1234)\n\ntrainingTruth.repartition(1).write.mode(SaveMode.Overwrite).option(\"compression\", \"gzip\").\nparquet(s\"s3a://strava.scratch/gbm/bay-area/etaGroundTruthTrain\")\n\nvalidationTruth.repartition(1).write.mode(SaveMode.Overwrite).option(\"compression\", \"gzip\").\nparquet(s\"s3a://strava.scratch/gbm/bay-area/etaGroundTruthValidation\")","user":"anonymous","dateUpdated":"2020-01-08T23:38:06+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"trainingTruth: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [edgeUID: bigint, athleteId: bigint ... 2 more fields]\nvalidationTruth: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [edgeUID: bigint, athleteId: bigint ... 2 more fields]\n"}]},"apps":[],"jobName":"paragraph_1575579530373_-262823683","id":"20191205-205850_746916298","dateCreated":"2019-12-05T20:58:50+0000","dateStarted":"2020-01-08T23:38:06+0000","dateFinished":"2020-01-08T23:38:41+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:136124"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1577126335744_-1441608105","id":"20191223-183855_355496377","dateCreated":"2019-12-23T18:38:55+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:136125"}],"name":"/lucindaz/groundTruth","id":"2ETT6CT31","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}