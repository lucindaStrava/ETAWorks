{"paragraphs":[{"text":"`import com.strava.commons.util.geo.GeoHash\nimport com.strava.commons.util.geo.Geometry\nimport com.strava.commons.thrift.Point\nimport spark.implicits._\nimport org.apache.spark.sql.functions.broadcast","user":"anonymous","dateUpdated":"2020-01-09T19:13:35+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import com.strava.commons.util.geo.GeoHash\nimport com.strava.commons.util.geo.Geometry\nimport com.strava.commons.thrift.Point\nimport spark.implicits._\nimport org.apache.spark.sql.functions.broadcast\n"}]},"apps":[],"jobName":"paragraph_1574702017471_-1036907726","id":"20190927-095315_620930610","dateCreated":"2019-11-25T17:13:37+0000","dateStarted":"2020-01-09T18:35:57+0000","dateFinished":"2020-01-09T18:35:57+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:133508"},{"text":" val edges = spark.read.parquet(\"s3a://strava.gbm/builds/190902/edges\").select(\"id\", \"sourceHash\").as[(Long, Long)].filter{x => \n     Geometry.distance(GeoHash.decode(x._2), Point(37.771, -122.452)) < 50000\n }\n val edgeIds = broadcast(edges.map(_._1).cache())\n ","user":"anonymous","dateUpdated":"2020-01-09T18:36:01+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"edges: org.apache.spark.sql.Dataset[(Long, Long)] = [id: int, sourceHash: bigint]\nedgeIds: org.apache.spark.sql.Dataset[Long] = [value: bigint]\n"}]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["true/jobs/job?id=3906","true/jobs/job?id=3906","true/jobs/job?id=3906","true/jobs/job?id=3906","true/jobs/job?id=3906"],"interpreterSettingId":"spark"}},"apps":[],"jobName":"paragraph_1574702017513_-1910680001","id":"20191125-170801_1229195256","dateCreated":"2019-11-25T17:13:37+0000","dateStarted":"2020-01-09T18:36:01+0000","dateFinished":"2020-01-09T18:36:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:133509"},{"text":"Range(1855, 2822).foreach{ key =>\n  print(s\"processing key=$key \\n\")\n  val alignment = spark.read.parquet(s\"s3a://strava.gbm/builds/190902/alignment/key=$key\").\n  select(\"activityId\", \"athleteId\", \"edgeUID\", \"activityType\", \"streamStartPointer\", \"streamEndPointer\", \"meanDistance\", \"elapsedTime\", \"meanSpeed\", \"coverage\", \"startDateLocal\", \"edgeID\")\n  alignment.joinWith(edgeIds, alignment(\"edgeID\") === edgeIds(\"value\")).select(\"_1.*\").repartition(1).\n  write.mode(\"overwrite\").option(\"compression\", \"gzip\").\n  parquet(s\"s3a://strava.scratch/gbm/bay-area/alignment/key=$key\")\n}","user":"anonymous","dateUpdated":"2019-11-25T17:14:50+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1574702017516_-334539621","id":"20191011-184028_1976348004","dateCreated":"2019-11-25T17:13:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:133510"},{"text":" val edges = spark.read.parquet(\"s3a://strava.gbm/builds/190902/edges\")\n edges.printSchema","user":"anonymous","dateUpdated":"2020-01-09T19:21:12+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"edges: org.apache.spark.sql.DataFrame = [id: int, activityId: bigint ... 6 more fields]\nroot\n |-- id: integer (nullable = true)\n |-- activityId: long (nullable = true)\n |-- profile: string (nullable = true)\n |-- points: string (nullable = true)\n |-- properties: struct (nullable = true)\n |    |-- length: double (nullable = true)\n |    |-- riderCount: integer (nullable = true)\n |    |-- riderCountRev: integer (nullable = true)\n |    |-- runnerCount: integer (nullable = true)\n |    |-- runnerCountRev: integer (nullable = true)\n |    |-- bikeTime: double (nullable = true)\n |    |-- bikeTimeRev: double (nullable = true)\n |    |-- elevationGain: double (nullable = true)\n |    |-- elevationGainRev: double (nullable = true)\n |    |-- meanAscentGradient: double (nullable = true)\n |    |-- meanAscentGradientRev: double (nullable = true)\n |    |-- clazz: integer (nullable = true)\n |    |-- routeable: boolean (nullable = true)\n |    |-- routeableRev: boolean (nullable = true)\n |-- roadName: string (nullable = true)\n |-- sourceHash: long (nullable = true)\n |-- targetHash: long (nullable = true)\n\n"}]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["true/jobs/job?id=4089","true/jobs/job?id=4089","true/jobs/job?id=4089","true/jobs/job?id=4089","true/jobs/job?id=4089"],"interpreterSettingId":"spark"}},"apps":[],"jobName":"paragraph_1574702017528_-1029009078","id":"20190927-223730_1083186825","dateCreated":"2019-11-25T17:13:37+0000","dateStarted":"2020-01-09T19:21:12+0000","dateFinished":"2020-01-09T19:21:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:133511"},{"text":"edgeIds.write.mode(\"overwrite\").option(\"compression\", \"gzip\").parquet(s\"s3a://strava.scratch/gbm/bay-area/tempId\")\nval ids = spark.read.load(s\"s3a://strava.scratch/gbm/bay-area/tempId\").cache()\nedges.joinWith(ids, edges(\"id\") === ids(\"value\")).select(\"_1.*\").\nrepartition(1).write.mode(\"overwrite\").option(\"compression\", \"gzip\").parquet(s\"s3a://strava.scratch/gbm/bay-area/edgeMeta\")","user":"anonymous","dateUpdated":"2020-01-09T19:27:56+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["true/jobs/job?id=4090","true/jobs/job?id=4090","true/jobs/job?id=4090","true/jobs/job?id=4090","true/jobs/job?id=4090"],"interpreterSettingId":"spark"}},"apps":[],"jobName":"paragraph_1578597679534_-616678838","id":"20200109-192119_1212521684","dateCreated":"2020-01-09T19:21:19+0000","dateStarted":"2020-01-09T19:22:39+0000","dateFinished":"2020-01-09T19:22:53+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:133512"},{"text":"\n\nspark.sql(myQuery).collect","user":"anonymous","dateUpdated":"2020-01-09T21:32:34+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"activityDf: org.apache.spark.sql.DataFrame = [activityId: bigint, athleteId: bigint ... 10 more fields]\nmyQuery: String =\n\"\nwith x as (\n\n    SELECT activityId, edgeUID, athleteId\n    FROM\n    activity\n    lateral view explode(edgeList) exploded_table as edgeUID\n    where activityId = 2131442930\n\n\n)\n\nselect count(1) as num, sum(meta.properties.length) as distance\nfrom x join meta\non abs(x.edgeUID) = meta.id\n\n\"\nres41: Array[org.apache.spark.sql.Row] = Array([218,8886.1315])\n"}]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["true/jobs/job?id=4098","true/jobs/job?id=4098","true/jobs/job?id=4098","true/jobs/job?id=4098","true/jobs/job?id=4098","true/jobs/job?id=4099","true/jobs/job?id=4099","true/jobs/job?id=4099","true/jobs/job?id=4099","true/jobs/job?id=4099","true/jobs/job?id=4100","true/jobs/job?id=4100","true/jobs/job?id=4100","true/jobs/job?id=4100","true/jobs/job?id=4100"],"interpreterSettingId":"spark"}},"apps":[],"jobName":"paragraph_1578596345184_558042403","id":"20200109-185905_307869359","dateCreated":"2020-01-09T18:59:05+0000","dateStarted":"2020-01-09T19:28:55+0000","dateFinished":"2020-01-09T19:29:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:133513"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1578597430181_-139315743","id":"20200109-191710_1631054651","dateCreated":"2020-01-09T19:17:10+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:133514"}],"name":"/lucindaz/filterAlignByGeoHash","id":"2EVWBK6EV","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}